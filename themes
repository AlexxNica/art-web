<?php

/* $Id$ */

require("mysql.inc.php");
require("common.inc.php");
require("ago_headers.inc.php");
require("comments.inc.php");
require("art.inc.php");

// superglobals stuff
$page = validate_input_regexp_default ($_GET["page"], "^[0-9]+$", 1);
$sort_by = validate_input_array_default ($_GET["sort_by"], array ("name","date","popularity","rating"), "date");
$thumbnails_per_page = validate_input_regexp_default ($_GET["thumbnails_per_page"], "^[0-9]+$", 12);
$view = validate_input_array_default ($_GET["view"], array ("list","icons"), "list");
$order = validate_input_array_default ($_GET['order'], array("ASC", "DESC"), "DESC");
list($foo, $unvalidated_category, $unvalidated_themeID) = explode("/", $_SERVER["PATH_INFO"]);
$new_rating = validate_input_regexp_default ($_POST["rating"], "^[1-5]$", -1);
if  (get_magic_quotes_gpc() == 1)
	$comment = stripslashes($_POST["comment"]); // This is validated later
else
	$comment = $_POST["comment"];
$commentID = validate_input_regexp_default ($_POST["commentID"], "^[0-9]+$", -1);
$report = $_POST["report"];

/* print out the list of theme categories */
if ($unvalidated_category == "")
{
	ago_header("Desktop Themes");
	create_title("Themes", "Desktop Themes");

	print("<ul>");
	reset($theme_config_array);
	while(list($key,$val)=each($theme_config_array))
	{
		$active = $val["active"];
		if($active)
		{
			$name = $val["name"];
			$url = $val["url"];
			$description = $val["description"];
			print("<li><a class=\"bold-link\" href=\"$url\">$name</a> - $description</li>\n");
		}
	}
	print("</ul>\n");

	ago_footer();
}
else
{
	$category = validate_input_regexp_error ($unvalidated_category, "^[0-9a-z_\-]+$");

	/* print out theme preview page */
	if (array_key_exists($category,$theme_config_array) && $unvalidated_themeID == "")
	{
		ago_header($theme_config_array[$category]["name"]);
		create_title($theme_config_array[$category]["name"], $theme_config_array[$category]["description"]);

		$theme_select_all_result = mysql_query("SELECT * FROM theme WHERE category='$category' AND parent = 0 ORDER BY add_timestamp DESC");
		$num_themes = mysql_num_rows($theme_select_all_result);
		if($num_themes == 0)
		{
			print("No themes have been added to this section yet.");
		}
		else
		{
			print_thumbnails_per_page_form($thumbnails_per_page, $sort_by, "Themes", $view, $order);
			list($page, $num_pages) = theme_search_result("", "theme_name", $category, $thumbnails_per_page, $sort_by, $page, $num_themes, $view, $order);
			
			/* Page Navigation System */
			print("<div style=\"clear:both; text-align: center;\">\n");
			if($page > 1)
			{
				$prev_page = $page -1;
				print(" <a class=\"box\" href=\"" . $_SERVER["PHP_SELF"] . "?page=$prev_page&amp;sort_by=$sort_by&amp;thumbnails_per_page=$thumbnails_per_page&amp;view=$view&amp;order=$order\">&lt;</a>");
			}
			for($count=1;$count<=$num_pages;$count++)
			{
				if($count == $page)
					print(" <strong>$count</strong> ");
				else
					print("<a class=\"box\" href=\"" . $_SERVER["PHP_SELF"] . "?page=$count&amp;sort_by=$sort_by&amp;thumbnails_per_page=$thumbnails_per_page&amp;view=$view&amp;order=$order\">$count</a>");
			}
			if($page < $num_pages)
			{
				$next_page = $page +1;
				print("<a class=\"box\" href=\"" . $_SERVER["PHP_SELF"] . "?page=$next_page&amp;sort_by=$sort_by&amp;thumbnails_per_page=$thumbnails_per_page&amp;view=$view&amp;order=$order\">&gt;</a>");
			}
			print("</div>");
		}
		ago_footer();
	}

	/* print out the individual theme page */
	else if( array_key_exists($category,$theme_config_array) && $unvalidated_themeID != "")
	{
		$themeID = validate_input_regexp_error ($unvalidated_themeID, "^[0-9]+$");

		ago_header($theme_config_array[$category]["name"]);
		$comment_result = add_comment($themeID, "theme", $comment);
		report_comment($report, $commentID);
		if($new_rating != '-1')
		{
			if(is_logged_in('vote'))
				add_vote($themeID, $new_rating, $_SESSION['userID'], 'theme');
		}


		print_detailed_view($themeID, 'theme');

		
		print_comments($themeID, "theme");
		print($comment_result);
		print_comment_form($comment);

		ago_footer();
	}
	else
	{
		ago_file_not_found();
	}
}

?>
