<?php

/* $Id$ */

require("mysql.inc.php");
require("common.inc.php");
require("ago_headers.inc.php");

// superglobals stuff
$page = validate_input_regexp_default ($_GET["page"], "^[0-9]+$", 1);
$sort_by = validate_input_array_default ($_GET["sort_by"], array ("name","date","popularity"), "date");
$thumbnails_per_page = validate_input_regexp_default ($_GET["thumbnails_per_page"], "^[0-9]+$", 12);
$view = validate_input_array_default ($_GET["view"], array ("list","icons"), "list");
list($foo, $unvalidated_author) = explode("/", $_SERVER["PATH_INFO"]);

/* print out the list of authors */
if ($unvalidated_author == "")
{
	ago_header("Users");
	create_title("Users", "The people creating the artwork");
	$author_list_result = mysql_query("SELECT user.userID,user.username FROM user,theme,background WHERE active = 1 AND (user.userID = theme.userID OR user.userID = background.userID) GROUP BY user.userID ORDER BY username ASC");
	print("<ul>\n");
	while (list($userID, $username) = mysql_fetch_row($author_list_result))
	{
		print("\t<li><a href=\"/users/$userID\">$username</a></li>\n");
	}
	print("</ul>\n");
	ago_footer();

}
else
{
	if (is_numeric($unvalidated_author))
		$authorID = validate_input_regexp_error ($unvalidated_author, "^[0-9]+$");
	else {
		if (get_magic_quotes_runtime() == 1)
		{
			$unvalidated_author = stripslashes($unvalidated_author);
		}
		$authorusername = mysql_real_escape_string($unvalidated_author);
	}
	if ($authorID != "")
	{

		$author_result = mysql_query ("SELECT realname,email,homepage,info,location FROM user WHERE userID = $authorID");
		if(mysql_num_rows($author_result) == 1)
		{
			extract(mysql_fetch_array($author_result));
			$email = spam_proof_email ($email);
			ago_header($realname);
			if ($authorID == $_SESSION['userID'])
				create_title ($realname, "<a href=\"/account.php\">Edit</a> your profile.");
			else
				create_title ($realname, "");
			if($info)
				print ("<p>$info</p>\n");
			if($email || $homepage || $location)
				$table = 1;
			if ($table)
				print("<table>\n");
			if($email) {
				print("\t<tr><td><img src=\"/images/site/stock_mail.png\" alt=\"e-mail\" /></td>\n");
				print("\t\t<td><a href=\"mailto:$email\">$email</a></td></tr>\n");
			}	
			if($homepage) {
				print("\t<tr><td><img src=\"/images/site/stock_home.png\" alt=\"homepage\" /></td>\n");
				print("\t\t<td><a href=\"$homepage\">$homepage</a></td></tr>\n");
			}
			if($location) {
				print("\t<tr><td><img src=\"/images/site/stock_home.png\" alt=\"location\" /></td>\n");
				print("\t\t<td>$location</td></tr>\n");
			}
			if($table)
				print("</table>\n");
	
			$author_themes_result = mysql_query ("SELECT themeID FROM theme WHERE userID = $authorID AND status='active' ORDER BY add_timestamp DESC LIMIT 40");

			if (mysql_num_rows ($author_themes_result) > 0)
			{
				create_title ("Themes", "Themes created by $realname");
				while (list ($themeID) = mysql_fetch_row ($author_themes_result))
					print_theme_row($themeID, "list");
			}

			$author_background_result = mysql_query ("SELECT backgroundID FROM background WHERE userID = $authorID AND status='active' ORDER BY add_timestamp DESC LIMIT 40 ");
			if (mysql_num_rows ($author_background_result) > 0)
			{
				create_title ("Backgrounds", "Backgrounds created by $realname");
				while (list ($backgroundID) = mysql_fetch_row ($author_background_result))
					print_background_row($backgroundID, "list");
			}
			ago_footer();
		}
		else {
			ago_file_not_found();
		}
	}
	elseif($authorusername !='')
	{
		rawurldecode($authorusername);
		$author_result = mysql_query ("SELECT userID,realname,email,homepage,info,location FROM user WHERE `username` = '$authorusername'");

		if(mysql_num_rows($author_result) == 1)
		{
			extract(mysql_fetch_array($author_result));
			$email = spam_proof_email ($email);
			ago_header($realname);
			if ($userID == $_SESSION['userID'])
				create_title ($realname, "<a href=\"/account.php\">Edit</a> your profile.");
			else
				create_title ($realname, "");
			if($info)
				print ("<p>$info</p>\n");
			if($email || $homepage || $location)
				$table = 1;
			if ($table)
				print("<table>\n");
			if($email) {
				print("\t<tr><td><img src=\"/images/site/stock_mail.png\" alt=\"e-mail\" /></td>\n");
				print("\t\t<td><a href=\"mailto:$email\">$email</a></td></tr>\n");
			}	
			if($homepage) {
				print("\t<tr><td><img src=\"/images/site/stock_home.png\" alt=\"homepage\" /></td>\n");
				print("\t\t<td><a href=\"$homepage\">$homepage</a></td></tr>\n");
			}
			if($location) {
				print("\t<tr><td><img src=\"/images/site/stock_home.png\" alt=\"location\" /></td>\n");
				print("\t\t<td>$location</td></tr>\n");
			}
			if($table)
				print("</table>\n");	

			$author_themes_result = mysql_query ("SELECT themeID FROM theme WHERE userID = $userID AND status='active' ORDER BY add_timestamp DESC LIMIT 40");

			if (mysql_num_rows ($author_themes_result) > 0)
			{
				create_title ("Themes", "Themes created by $realname");
				while (list ($themeID) = mysql_fetch_row ($author_themes_result))
					print_theme_row($themeID, "list");
			}

			$author_background_result = mysql_query ("SELECT backgroundID FROM background WHERE userID = $userID AND status='active' ORDER BY add_timestamp DESC LIMIT 40 ");
			if (mysql_num_rows ($author_background_result) > 0)
			{
				create_title ("Backgrounds", "Backgrounds created by $realname");
				while (list ($backgroundID) = mysql_fetch_row ($author_background_result))
					print_background_row($backgroundID, "list");
			}
			ago_footer();
		}
		else
		{
			ago_file_not_found();
		}
	}
	else
	{
		ago_file_not_found();
	}
}

?>
