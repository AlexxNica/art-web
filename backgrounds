<?php

/* $Id$ */

require("mysql.inc.php");
require("common.inc.php");
require("ago_headers.inc.php");

// superglobals stuff
$page = validate_input_regexp_default ($_GET["page"], "^[0-9]+$", 1);
$sort_by = validate_input_array_default ($_GET["sort_by"], array ("name","date","popularity") ,"date");
$thumbnails_per_page = validate_input_regexp_default ($_GET["thumbnails_per_page"], "^[0-9]+$", 12);
$view = validate_input_array_default ($_GET["view"], array ("list","icons"), "list");
list($foo, $unvalidated_category, $unvalidated_backgroundID) = explode("/", $_SERVER["PATH_INFO"]);

/* print out the list of background categories */
if ($unvalidated_category == "")
{
	ago_header("BACKGROUNDS");
	create_middle_box_top("backgrounds");

	print("Backgrounds are images for use on your desktop as the desktop background, sometimes known as wallpapers.");
	
	print("<p>\n<table border=\"0\" cellpadding=\"4\">");
	reset($background_config_array);
	while(list($key,$val)=each($background_config_array))
	{
		$name = $val["name"];
		$url = $val["url"];
		$description = $val["description"];
		print("<tr><td valign=\"top\"><img src=\"/images/site/circle.png\"></td><td><a class=\"bold-link\" href=\"$url\">$name</a> - $description</td></tr>\n");
	}
	print("</table>\n");
	
	create_middle_box_bottom();
	ago_footer();
}
else
{
	$category = validate_input_regexp_error ($unvalidated_category, "^[0-9a-z_\-]+$");
	
	/* print out the background preview pages */
	if (array_key_exists ($category, $background_config_array) && $unvalidated_backgroundID == "")
	{
		ago_header("BACKGROUNDS - " . strtoupper($category));
		$temp = "backgrounds_" . $category;
		create_middle_box_top($temp);
		
		$background_select_all_result = mysql_query("SELECT * FROM background WHERE category='$category' AND status='active'AND parent='0' ORDER BY add_timestamp DESC");
		$num_backgrounds = mysql_num_rows($background_select_all_result);
		if($num_backgrounds == 0)
		{
			print("No backgrounds have been added to this section yet.");
		}
		else
		{
			print_thumbnails_per_page_form($thumbnails_per_page, $sort_by, "Backgrounds", $view);
			print("<p>");
			list($page, $num_pages) = background_search_result("", "background_name", $category, $thumbnails_per_page, $sort_by, $page, $num_backgrounds, $view);

			print("<div align=\"center\">\n");
			/* Page Navigation System */
			if($page > 1)
			{
				$prev_page = $page -1;
				print(" <a href=\"" . $_SERVER["PHP_SELF"] . "?page=$prev_page&sort_by=$sort_by&thumbnails_per_page=$thumbnails_per_page&view=$view\">[&lt;]</a>");
			}
			for($count=1;$count<=$num_pages;$count++)
			{
				if($count == $page)
				{
					print("<span class=\"bold-text\">[$count]</span> ");
				}
				else
				{
					print("<a href=\"" . $_SERVER["PHP_SELF"] . "?page=$count&sort_by=$sort_by&thumbnails_per_page=$thumbnails_per_page&view=$view\">[$count]</a> ");
				}
			}
			if($page < $num_pages)
			{
				$next_page = $page +1;
				print(" <a href=\"" . $_SERVER["PHP_SELF"] . "?page=$next_page&sort_by=$sort_by&thumbnails_per_page=$thumbnails_per_page&view=$view\">[&gt;]</a>");
			}
			print("</div><p>\n");
		}

		create_middle_box_bottom();
		ago_footer();
	}

	/* print out the individual background page */
	else if (array_key_exists ($category,$background_config_array) && $unvalidated_backgroundID != "")
	{
		$backgroundID = validate_input_regexp_error ($unvalidated_backgroundID, "^[0-9]+$");

		$background_select_result = mysql_query("SELECT * FROM background WHERE backgroundID='$backgroundID'");
		if(mysql_num_rows($background_select_result)==0)
		{
			ago_file_not_found();
		}
		else
		{
			ago_header("BACKGROUNDS - " . strtoupper($category));
			$temp = "backgrounds_" . $category;
			create_middle_box_top($temp);
			$background_select_row = mysql_fetch_array($background_select_result);
			$thumbnail_filename = $background_select_row["thumbnail_filename"];
			$screenshot_filename = $background_select_row["screenshot_filename"];
			$name = $background_select_row["background_name"];
			$author = $background_select_row["author"];
			$author_email = $background_select_row["author_email"];
			$author_email = spam_proof_email($author_email);
			$release_date = $background_select_row["release_date"];
			list($year,$month,$day)=explode("-",$release_date);
			$release_date = $month . "/" . $day . "/" . $year;
			$background_description = $background_select_row["background_description"];
			$screenshot_description = $background_select_row["screenshot_description"];
			$download_start_timestamp = $background_select_row["download_start_timestamp"];
			$download_count = $background_select_row["download_count"];
			$background_resolution_select_result = mysql_query("SELECT background_resolutionID, type, resolution, filename FROM background_resolution WHERE backgroundID='$backgroundID' ORDER BY type,resolution");
			print("<table border=\"0\">\n<tr><td valign=\"top\">");
			print("<img src=\"/images/thumbnails/backgrounds/$thumbnail_filename\" class=\"thumbnail-border-padding\">\n");
			print("</td><td>\n");
			print("<span class=\"bold-text\">Name:</span> $name<br>\n<span class=\"bold-text\">Author:</span> <a href=\"mailto:$author_email\">$author</a><br>\n<span class=\"bold-text\">Release Date:</span> $release_date<br>\n");
			$downloads_per_day = calculate_downloads_per_day($download_count, $download_start_timestamp);
			print("<span class=\"bold-text\">Popularity:</span> $downloads_per_day Downloads per Day<br>\n");
			print("<span class=\"bold-text\">Resolutions:</span>");
			while(list($background_resolutionID,$type,$resolution,$filename)=mysql_fetch_row($background_resolution_select_result))
			{
				if($current_type != $type)
				{
					print("<br>\n&nbsp;&nbsp;");
					$current_type = $type;
				}
				else
				{
					print(" ;\n");
				}
				//print("<a href=\"$mirror_url/backgrounds/$filename\">" . $type . "-" . $resolution . "</a>\n");
				print("<a href=\"/download/backgrounds/$category/$background_resolutionID/$filename\">" . $type . "-" . $resolution . "</a>\n");

			}
			print("<br>\n");
			if($screenshot_filename != "")
			{
				print("<a href=\"/images/screenshots/$screenshot_filename\" class=\"bold-link\">Screenshot</a><p>\n");
			}
			print("</td></tr></table>\n");
			print("<p>\n<span class=\"bold-text\">Info (Picture):</span> $background_description\n");
			if($screenshot_description != "")
			{
				print("<p>\n<span class=\"bold-text\">Info (Screenshot):</span> $screenshot_description\n");
			}
			$back_select_result = mysql_query("SELECT backgroundID,background_name,category FROM background WHERE parent='$backgroundID'");
			if(mysql_num_rows($back_select_result)>0)
			{
				print("<p>\n<span class=\"bold-text\">Variations:</span> ");
				while(list($backID,$back_name,$back_cat)=mysql_fetch_row($back_select_result))
				{
					if($first_toggle)
					{
						print(" - ");
					}
					else
					{
						$first_toggle = 1;
					}
					print("<a href=\"/backgrounds/$back_cat/$backID.php\">$back_name</a>");

				}
			}
		create_middle_box_bottom();
		ago_footer();
		}
	}
	else
	{
		ago_file_not_found();	
	}
}
?>
