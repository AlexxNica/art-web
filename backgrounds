<?php

/* $Id$ */

require("mysql.inc.php");
require("common.inc.php");
require("ago_headers.inc.php");
require("comments.inc.php");
require("art.inc.php");

// superglobals stuff
$page = validate_input_regexp_default ($_GET["page"], "^[0-9]+$", 1);
$sort_by = validate_input_array_default ($_GET["sort_by"], array ("name","date","popularity","rating") ,"date");
$thumbnails_per_page = validate_input_regexp_default ($_GET["thumbnails_per_page"], "^[0-9]+$", 12);
$view = validate_input_array_default ($_GET["view"], array ("list","icons"), "list");
list($foo, $unvalidated_category, $unvalidated_backgroundID) = explode("/", $_SERVER["PATH_INFO"]);
$rating = validate_input_regexp_default ($_POST["rating"], "^[1-5]$", -1);
if  (get_magic_quotes_gpc() == 1)
	$comment = stripslashes($_POST["comment"]); // This is validated later
else
	$comment = $_POST["comment"];
$commentID = validate_input_regexp_default ($_POST["commentID"], "^[0-9]+$", -1);
$report = $_POST["report"];

/* print out the list of background categories */
if ($unvalidated_category == "")
{
	ago_header("Backgrounds");
	create_title("backgrounds", "Backgrounds are images for use on your desktop as the desktop background, sometimes known as wallpapers.");
	
	print("<ul>\n");
	reset($background_config_array);
	while(list($key,$val)=each($background_config_array))
	{
		$name = $val["name"];
		$url = $val["url"];
		$description = $val["description"];
		print("\t<li><a class=\"bold-link\" href=\"$url\">$name</a> - $description</li>\n");
	}
	print("</ul>\n");
	
	ago_footer();
}
else
{
	$category = validate_input_regexp_error ($unvalidated_category, "^[0-9a-z_\-]+$");
	
	/* print out the background preview pages */
	if (array_key_exists ($category, $background_config_array) && $unvalidated_backgroundID == "")
	{
		ago_header($background_config_array[$category]["name"] ." Backgrounds");
		create_title($background_config_array[$category]["name"] ." Backgrounds", $background_config_array[$category]["description"]);
		
		$background_select_all_result = mysql_query("SELECT * FROM background WHERE category='$category' AND status='active'AND parent='0' ORDER BY add_timestamp DESC");
		$num_backgrounds = mysql_num_rows($background_select_all_result);
		if($num_backgrounds == 0)
		{
			print("No backgrounds have been added to this section yet.");
		}
		else
		{
			print_thumbnails_per_page_form($thumbnails_per_page, $sort_by, "Backgrounds", $view);
			list($page, $num_pages) = background_search_result("", "background_name", $category, $thumbnails_per_page, $sort_by, $page, $num_backgrounds, $view);

			print("<div style=\"clear:both; text-align:center\">\n");
			/* Page Navigation System */
			if($page > 1)
			{
				$prev_page = $page -1;
				print("<a class=\"box\" href=\"" . $_SERVER["PHP_SELF"] . "?page=$prev_page&amp;sort_by=$sort_by&amp;thumbnails_per_page=$thumbnails_per_page&amp;view=$view\">&lt;</a>\n");
			}
			for($count=1;$count<=$num_pages;$count++)
			{
				if($count == $page)
				{
					print(" <strong>$count</strong>\n ");
				}
				else
				{
					print("<a class=\"box\" href=\"" . $_SERVER["PHP_SELF"] . "?page=$count&amp;sort_by=&amp;sort_by&amp;thumbnails_per_page=$thumbnails_per_page&amp;view=$view\">$count</a>\n");
				}
			}
			if($page < $num_pages)
			{
				$next_page = $page +1;
				print("<a class=\"box\" href=\"" . $_SERVER["PHP_SELF"] . "?page=$next_page&amp;sort_by=$sort_by&amp;thumbnails_per_page=$thumbnails_per_page&amp;view=$view\">&gt;</a>\n");
			}
			print("</div>\n");
		}

		ago_footer();
	}

	/* print out the individual background page */
	else if (array_key_exists ($category,$background_config_array) && $unvalidated_backgroundID != "")
	{
		$backgroundID = validate_input_regexp_error ($unvalidated_backgroundID, "^[0-9]+$");

		report_comment($report, $commentID);

		$background_select_result = mysql_query("SELECT * FROM background WHERE backgroundID='$backgroundID'");
		if(mysql_num_rows($background_select_result)==0)
		{
			ago_file_not_found();
		}
		else
		{
			ago_header($background_config_array[$category]["name"] ." Backgrounds");


			$temp = "backgrounds_" . $category;
			$background_select_row = mysql_fetch_array($background_select_result);
			$thumbnail_filename = $background_select_row["thumbnail_filename"];
			$screenshot_filename = $background_select_row["screenshot_filename"];
			$name = html_parse_text($background_select_row["background_name"]);
			$userID = $background_select_row["userID"];
			$user_select_result = mysql_query("SELECT username FROM user WHERE userID = $userID");
			list($author) = mysql_fetch_row($user_select_result);
			$release_date = $background_select_row["release_date"];
			$background_description = $background_select_row["background_description"];
			$download_start_timestamp = $background_select_row["download_start_timestamp"];
			$download_count = $background_select_row["download_count"];
			$add_timestamp = $background_select_row["add_timestamp"];
			$license = $background_select_row["license"];
			$version = $background_select_row["version"];

			add_vote($backgroundID, $rating, $_SESSION['userID'], 'background');

			$background_resolution_select_result = mysql_query("SELECT background_resolutionID, type, resolution, filename FROM background_resolution WHERE backgroundID='$backgroundID' ORDER BY type,resolution");
			$vote_result = mysql_query("SELECT rating, userID FROM vote WHERE artID='$backgroundID' AND type='background'");
			$vote_count = mysql_num_rows($vote_result);
			$i = 0;
			while (list($rating,$dbuserID) = mysql_fetch_array($vote_result)) {
				$vote_sum += $rating;
				if($dbuserID == $_SESSION['userID']) {
					$i++;
					$userrating = $rating;
				}
			}
			$vote = -1;
			if ($i >= 1)
				$vote = 0;
			if (!isset($_SESSION['userID']) || $_SESSION['userID'] == 0)
				$vote = 1;
			elseif ($_SESSION['userID'] == $userID)
				$vote = 2;


			create_title($name . " by <a href=\"/users/$userID\">$author</a>", $background_config_array[$category]["name"] . " Backgrounds");
			
			

			if ($backgroundID < 1000)
				$thumbnail_url = "{$site_url}images/archive/thumbnails/backgrounds/$thumbnail_filename";
			else
				$thumbnail_url = "{$site_url}images/thumbnails/backgrounds/$thumbnail_filename";

			$more = "<tr><th>Resolutions</th><td>\n";
			while(list($background_resolutionID,$type,$resolution,$filename)=mysql_fetch_row($background_resolution_select_result))
			{
				if ($backgroundID < 1000) {
					$more .= "<a href=\"/download/backgrounds/$category/$background_resolutionID/$filename\" class=\"$type\">&nbsp;$type - $resolution</a>&nbsp;&nbsp;\n";
				} else {
					$more .= "<a href=\"/download/backgrounds/$category/$background_resolutionID/$filename\" class=\"$type\">&nbsp;$type - $resolution</a>&nbsp;&nbsp;\n";
				}
			}

			$more .= "</td></tr></table>\n";

			print_detailed_view($background_description, "background", $release_date, $add_timestamp, $version, $license, $download_count, $download_start_timestamp, $vote, $vote_sum, $vote_count, $more, $thumbnail_url, $userrating);

			$back_select_result = mysql_query("SELECT backgroundID,background_name,category,thumbnail_filename FROM background WHERE parent='$backgroundID'");
			if(mysql_num_rows($back_select_result)>0)
			{
				create_title("Variations", "This background has a number of variations");
				while(list($backID,$back_name,$back_cat)=mysql_fetch_row($back_select_result))
				{
					print_background_row($backID, "icons");
				}
			}

			$comment_result = add_comment($backgroundID, "background", $comment);
			print_comments($backgroundID, "background");
			print($comment_result);
			print_comment_form($comment);
			ago_footer();
		}
	}
	else
	{
		ago_file_not_found();
	}
}
?>
